# My Keyboard Layouts
I recently got my first programmable split ergonomic mechanical keyboard (a [Dygma Defy](https://dygma.com/dygma-defy)) and I wanted to keep track of all the changes I've made to the layers and the config and things. I made a PowerShell module with some helper functions for syncing the backups from the folder where Bazecor puts them into the repo as separate commits, as well as doing some post-processing to extract the keymap, colormap, and palette data into text files that are more human readable/diffable.
## Steps to install the PowerShell module
1. `winget install jqlang.jq` (unless `jq` is already installed)
1. `Import-Module .\BazecorBackupManager.psm1` (this can be added to your PowerShell profile, with the full path of course)
## Cmdlets in the PowerShell module
- `Sync-BazecorBackups` is the main function to use that calls all the other ones to do the work for you. It takes in the `BackupsPath`, which should be the path to the folder with the json backup files exported by Bazecor, and an optional `LastBackupDate`, which is a datetime of the last time you synced into the repo so that it will skip copying, processing, and committing the backups on or before that datetime. The function loops over all of the json files in the backups folder, removes the neuron ID, saves the result into the repo as fullBackup-KeyboardName.json (where the keyboard name is the part of the backup filenames after the dash), calls to do the post-processing, and then if there were changes, commits the files with a descriptive message including the timestamp of the backup extracted from the original filename exported by Bazecor.
- `Remove-NeuronIdFromBackupJson` uses `jq` to remove the neuron ID from a few different places in the backup json files. It takes the path to the input json file with the full backup and a path to where the sanitized output file should be saved.
- `Save-DefyLayouts` does the post-processing on the backup json file after it's been sanitized. It uses `jq` to extract the keymap, colormap, and palette data and then calls the `Format-DefyXXX` cmdlets to format them in a more human-readable format and saves the results into separate files in the repo and staging them for committing so that the caller can commit them. The one parameter is the filename of the sanitized full backup file, which should also have the keyboard name after a dash, since that's used as part of the filename of the text files that get output. For now I just have this cmdlet for doing post-processing for my wireless Defy layout with underglow since that's what I have. If I ever get another keyboard or someone else wants this kind of functionality for other keyboards/configurations, then this functionality can be extended as needed.
- `Format-DefyKeyMap` takes in a string of the keymap data (from the keymap.custom command within the backup json) and returns a string of the data formatted to show the separate layers with the keycodes in the approximate places that they appear on the physical keyboard.
- `Format-DefyColorMap` takes in a string of the colormap data (from the colormap.map command within the backup json) and returns a string of the data formatted to show the separate layers with the color indexes for each key and each underglow LED in the approximate places that they appear on the physical keyboard. Not the prettiest given that it's just text-based, but it works better than looking at the raw data, and importantly it's diffable.
- `Format-DefyPalette` takes in a string of the color palette data (from the palette command within the backup json) and returns a string of the data formatted to show each of the colors in the palette with their index (which should correspond to the indices used in the colormap) and the RGB values of the colors as converted from the RGBW values stored in the data.
